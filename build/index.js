(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,n=(window.wp.plugins,window.wp.hooks),a=window.wp.compose,o=window.wp.element,r=window.wp.blockEditor,l=window.wp.components,c=window.wp.i18n,s=window.wp.data,i=window.wp.apiFetch;var u=e.n(i);function d(e,t){const n=document.querySelector(`[data-block="${e}"]`);n&&(t?n.classList.add("gutenblock-ai-generating"):n.classList.remove("gutenblock-ai-generating"))}const m=({usage:e})=>{if(!e)return null;if(e.is_pro)return(0,t.createElement)("div",{className:"gb-ai-tokens gb-ai-tokens-pro"},(0,t.createElement)("span",{className:"dashicons dashicons-awards"}),(0,c.__)("Unbegrenzte Tokens (Pro)","gutenblock-pro"));const n=Math.min(100,e.used/e.limit*100),a=n>95?"critical":n>80?"warning":"";return(0,t.createElement)("div",{className:"gb-ai-tokens"},(0,t.createElement)("div",{className:"gb-ai-tokens-bar"},(0,t.createElement)("div",{className:`gb-ai-tokens-progress ${a}`,style:{width:`${n}%`}})),(0,t.createElement)("div",{className:"gb-ai-tokens-text"},e.used.toLocaleString()," / ",e.limit.toLocaleString()," Tokens"))},g=({clientId:e,blockName:n,attributes:a})=>{const[r,i]=(0,o.useState)(!1),[g,k]=(0,o.useState)(""),[h,w]=(0,o.useState)(""),[E,_]=(0,o.useState)(null),[v,f]=(0,o.useState)({}),[C,N]=(0,o.useState)(""),{updateBlockAttributes:y}=(0,s.useDispatch)("core/block-editor"),P=a?.metadata?.name||"";(0,o.useEffect)(()=>{u()({path:"/gutenblock-pro/v1/prompts"}).then(e=>{f(e||{}),P&&e[P]&&w(e[P].prompt||"")}).catch(e=>console.error("Error loading prompts:",e)),u()({path:"/gutenblock-pro/v1/ai/usage"}).then(e=>_(e)).catch(e=>console.error("Error loading usage:",e))},[]),(0,o.useEffect)(()=>{P&&v[P]&&w(v[P].prompt||"")},[P,v]);const S=(0,o.useMemo)(()=>{const e=Object.entries(v).map(([e])=>({value:e,label:e}));return e.sort((e,t)=>e.label.localeCompare(t.label)),e},[v]),x=async(t=null)=>{i(!0),k(""),d(e,!0);try{const o=p(n,a),r=await u()({path:"/gutenblock-pro/v1/ai/generate",method:"POST",data:{prompt:h,blockName:P||n,currentText:o,feedback:t}});r.success&&r.text&&(b(e,n,r.text,y),r.usage&&_(r.usage))}catch(e){k(e.message||(0,c.__)("Fehler bei der Generierung","gutenblock-pro"))}finally{i(!1),d(e,!1)}};if(!["core/paragraph","core/heading","core/button","core/list-item"].includes(n))return null;const z=h&&h.trim().length>=3;return(0,t.createElement)(l.PanelBody,{title:(0,c.__)("GutenBlock AI","gutenblock-pro"),initialOpen:!0},(0,t.createElement)(l.PanelRow,null,(0,t.createElement)(m,{usage:E})),(0,t.createElement)(l.PanelRow,null,(0,t.createElement)("div",{className:"gb-ai-field-selector"},(0,t.createElement)(l.ComboboxControl,{label:(0,c.__)("Content-Feld","gutenblock-pro"),value:P,onChange:t=>{if(!t)return y(e,{metadata:{...a.metadata,name:void 0}}),void w("");y(e,{metadata:{...a.metadata,name:t}}),v[t]&&w(v[t].prompt||"")},options:S,onFilterValueChange:e=>N(e)}),P&&(0,t.createElement)("div",{className:"gb-ai-field-badge"},(0,t.createElement)("span",{className:"dashicons dashicons-yes-alt"}),P))),(0,t.createElement)(l.PanelRow,null,(0,t.createElement)(l.TextareaControl,{label:P?(0,c.__)("Prompt (aus Content-Feld)","gutenblock-pro"):(0,c.__)("Eigener Prompt","gutenblock-pro"),value:h,onChange:w,placeholder:(0,c.__)("Wähle ein Content-Feld oder schreibe einen eigenen Prompt...","gutenblock-pro"),rows:3,help:P?(0,c.__)("Der Prompt wird aus dem Content-Feld geladen. Du kannst ihn hier temporär anpassen.","gutenblock-pro"):null})),(0,t.createElement)(l.PanelRow,null,(0,t.createElement)("div",{className:"gb-ai-buttons"},(0,t.createElement)(l.Button,{isPrimary:!0,onClick:()=>x(),disabled:r||!z,className:"gb-ai-btn-generate"},r?(0,t.createElement)(l.Spinner,null):(0,c.__)("Generieren","gutenblock-pro")),(0,t.createElement)("div",{className:"gb-ai-btn-row"},(0,t.createElement)(l.Button,{isSecondary:!0,onClick:()=>x("Leicht ändern, andere Wortwahl."),disabled:r||!z,size:"small"},(0,c.__)("Variante","gutenblock-pro")),(0,t.createElement)(l.Button,{isSecondary:!0,onClick:()=>x("Komplett anderer Ansatz."),disabled:r||!z,size:"small"},(0,c.__)("Neu","gutenblock-pro"))),(0,t.createElement)("div",{className:"gb-ai-btn-row"},(0,t.createElement)(l.Button,{isSecondary:!0,onClick:()=>x("Verlängere den Text um 10%."),disabled:r||!z,size:"small"},(0,c.__)("+10%","gutenblock-pro")),(0,t.createElement)(l.Button,{isSecondary:!0,onClick:()=>x("Kürze den Text um 10%."),disabled:r||!z,size:"small"},(0,c.__)("-10%","gutenblock-pro")),(0,t.createElement)(l.Button,{isSecondary:!0,onClick:async()=>{i(!0),k(""),d(e,!0);try{const t=p(n,a);if(!t||t.length<3)return k((0,c.__)("Mindestens 3 Zeichen Text erforderlich","gutenblock-pro")),d(e,!1),void i(!1);const o=await u()({path:"/gutenblock-pro/v1/ai/generate",method:"POST",data:{prompt:`Übersetze den folgenden Text ins Englische. Antworte nur mit der Übersetzung:\n\n${t}`,blockName:"translation"}});o.success&&o.text&&(b(e,n,o.text,y),o.usage&&_(o.usage))}catch(e){k(e.message||(0,c.__)("Fehler bei der Übersetzung","gutenblock-pro"))}finally{i(!1),d(e,!1)}},disabled:r,size:"small"},(0,c.__)("→ EN","gutenblock-pro"))))),g&&(0,t.createElement)(l.PanelRow,null,(0,t.createElement)(l.Notice,{status:"error",isDismissible:!1},g)))};function p(e,t){switch(e){case"core/paragraph":case"core/heading":case"core/list-item":return t?.content||"";case"core/button":return t?.text||"";default:return""}}function b(e,t,n,a){switch(t){case"core/paragraph":case"core/heading":case"core/list-item":a(e,{content:n});break;case"core/button":a(e,{text:n})}}const k=(0,a.createHigherOrderComponent)(e=>n=>{const{clientId:a,name:l,attributes:c}=n;return(0,t.createElement)(o.Fragment,null,(0,t.createElement)(e,{...n}),(0,t.createElement)(r.InspectorControls,null,(0,t.createElement)(g,{clientId:a,blockName:l,attributes:c})))},"withAIControls");(0,n.addFilter)("editor.BlockEdit","gutenblock-pro/ai-controls",k),console.log("GutenBlock Pro AI loaded")})();